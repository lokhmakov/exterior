import React, { Component } from 'react'


import Image                from '2d/image/web/Image'
import LineTool             from '2d/lineTool/web/LineTool'
import Ruler                from '2d/ruler/web/Ruler'
import Stage                from '2d/stage/web/Stage'

import modeMap              from 'app/project/api/modeMap'
import projectQuery         from 'app/project/api/local/query'
import projectUpdate        from 'app/project/api/local/update'

import Mutation             from 'core/mutation/web/Mutation'
import Query                from 'core/query/web/Query'

import Block                from 'layout/web/Block'

import createDebugger       from 'core/debug/api/create'


const debug = createDebugger(`app:editor:web:EditorSection`)

class EditorSection extends Component {
  renderGroupAdd = ({ doc, mutate }) => {
    return (
      <LineTool
        onFinish={(({ path }) => mutate({
          ...doc,
          mode: modeMap.DEFAULT,
        }))}
      />
    )
  }

  renderScaleMeasure = ({ doc, mutate }) => {
    return (
      <Ruler
        onChange={({ length }) => console.log(`LENGTH`, length)}
        onFinish={({ length: unit }) => mutate({
          ...doc,
          unit,
          mode: modeMap.DEFAULT,
        })}
      />
    )
  }

  renderProjectQuery = ({ data, order }) => {
    const { id } = this.props

    if (!data[id]) return null

    const doc = data[id]
    const { imageLink } = doc
    const { mode } = doc

    //debug(`renderProjectQuery`, imageLink)

    return (
      <Mutation
        name='projectUpdate'
        entity='project'

        mutation={ projectUpdate }
      >
        {({ mutate }) => (
          <React.Fragment>
            <Image
              imageLink={ imageLink }
              width={ 800 }
            />
            { mode === modeMap.SCALE_MEASURE && this.renderScaleMeasure({ doc, mutate }) }
            { mode === modeMap.GROUP_ADD && this.renderGroupAdd({ doc, mutate })}
          </React.Fragment>
        )}
      </Mutation>
    )
  }

  render() {
    return (
      <Block style={{ height: 600 }} center middle>
        <Stage>
          <Query
            name='projectQuery'
            entity='project'

            query={ projectQuery }
          >
            { this.renderProjectQuery }
          </Query>
        </Stage>
      </Block>
    )
  }
}

export default EditorSection