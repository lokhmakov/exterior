import _update              from 'immutability-helper'

import { takeEvery }        from 'redux-saga/effects'
import { put }              from 'redux-saga/effects'


export default ({ name, processName = `UPDATE` }) => {
  const processNameDone = `${ processName }_DONE`

  const types = {
    [processName]:      `${ name }/${ processName }`,
    [processNameDone]:  `${ name }/${ processNameDone }`,
  }

  const reducerMap = {
    [types[processNameDone]]: (state, { payload, options }) => {
      const { 
        ns = `default`,
        entity = `default`,
      } = options || {}

      try {
        const { id } = payload
        const doc = state[ns][entity].data[id]

        return _update(state, {
          [ns]: {
            [entity]: {
              data: {
                $merge: { [id]: { ...doc, ...payload } },
              },
            },
          },
        })
      } catch (err) {
        return state
      }
    }
  }

  function* processUpdate({ payload, options }) {
    try {
      yield put({ type: types[processNameDone],  payload, options })
    } catch (error) {
      console.log(error)
    }
  }

  function* saga() {
    yield takeEvery(types[processName], processUpdate);
  }

  return {
    reducerMap,
    saga,
    types,
  }
}