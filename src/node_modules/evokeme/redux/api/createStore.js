import flatMap              from 'lodash/flatMap'
import mapValues            from 'lodash/mapValues'

import { applyMiddleware }  from 'redux'
import { combineReducers }  from 'redux'
import { compose }          from 'redux'
import { createStore }      from 'redux'

import createSagaMiddleware from 'redux-saga'
import { all }              from 'redux-saga/effects'


export default (entityMap) => {
  const rootReducer = combineReducers(
    mapValues(entityMap, entity => entity.reducer),
  )

  function* rootSaga() {
    yield all(
      flatMap(
        Object.values(entityMap).map(entity => entity.sagaList)
      )
    )
  }

  const composeEnhancers = compose

  const sagaMiddleware = createSagaMiddleware()

  const store = createStore(
    rootReducer,
    composeEnhancers(
      applyMiddleware(sagaMiddleware)
    ),
  )

  sagaMiddleware.run(rootSaga)

  return store
}